<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>MCBoost - Health Survey Example</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">MCBoost - Health Survey Example</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(PracTools)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(ranger)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(neuralnet)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">library</span>(formattable)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">library</span>(mlr3)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">library</span>(mlr3learners)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">library</span>(mcboost)</a></code></pre></div>
<div id="data-and-setup" class="section level2">
<h2>Data and Setup</h2>
<p>This vignette presents two typical use cases of MCBoost with data from a health survey. The goal is to post-process two initial prediction models for multi-accuracy using different flavors of MCBoost, and to eventually compare the naive and post-processed predictors overall and for subpopulations. The first scenario starts with a neural net and, as an example, evaluates the initial and post-processed predictors with a focus on subgroup accuracy after running MCBoost. The second scenario uses a random forest and evaluates the initial and post-processed predictors with respect to subgroup calibration.</p>
<p>We use data derived from the National Health Interview Survey (NHIS 2003), which includes demographic and health-related variables for 21,588 individuals. This data can directly be included from the <code>PracTools</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span>(nhis.large)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">#&gt; Warning in data(nhis.large): data set &#39;nhis.large&#39; not found</span></a></code></pre></div>
<p>We can obtain more information using:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">?nhis.large</a></code></pre></div>
<p>In the following, our outcome of interest is whether an individual is covered by any type of health insurance (<code>notcov</code>, 1 = not covered, 0 = covered). We additionally prepare two sets of variables:</p>
<ul>
<li>Predictor variables (age, parents in household, education, income, employment status, physical or other limitations)</li>
<li>Subpopulation variables (sex, hispanic ethnicity, race)</li>
</ul>
<p>The second set of variables will not be used for training the initial prediction models, but will be our focus when it comes to evaluating prediction performance for subgroups.</p>
<p>Before we training an initial model, we preprocess the data:</p>
<ul>
<li>We encode categorical features as <code>factor</code>.</li>
<li>We explicitly assign <code>NA</code>s in categorical features to a dedicated factor level</li>
<li>We drop <code>NA</code>s in the outcome variable <code>notcov</code></li>
<li>We encode <code>notcov</code> as a factor variable instead of a dummy variable (1 = <code>notcov</code>, 0 = <code>cov</code>)</li>
<li>We create a new feature <code>inv_wt</code> as the inverse of survey weights <code>svwyt</code></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">categorical &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;age.grp&quot;</span>, <span class="st">&quot;parents&quot;</span>, <span class="st">&quot;educ&quot;</span>, <span class="st">&quot;inc.grp&quot;</span>, <span class="st">&quot;doing.lw&quot;</span>,</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="st">&quot;limited&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;hisp&quot;</span>, <span class="st">&quot;race&quot;</span>)</a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4">nhis &lt;-<span class="st"> </span>nhis.large <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="st">  </span><span class="kw">mutate_at</span>(categorical, as.factor) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="st">  </span><span class="kw">mutate_at</span>(categorical, fct_explicit_na) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="st">  </span><span class="kw">drop_na</span>(notcov) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="st">  </span><span class="kw">select</span>(<span class="kw">all_of</span>(categorical), notcov, svywt, ID)</a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10">nhis<span class="op">$</span>notcov &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">ifelse</span>(nhis<span class="op">$</span>notcov <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;notcov&quot;</span>, <span class="st">&quot;cov&quot;</span>))</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">nhis_enc &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">model.matrix</span>(notcov <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> nhis)[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb4-13" title="13">nhis_enc<span class="op">$</span>notcov &lt;-<span class="st"> </span>nhis<span class="op">$</span>notcov</a>
<a class="sourceLine" id="cb4-14" title="14">nhis_enc<span class="op">$</span>sex &lt;-<span class="st"> </span>nhis<span class="op">$</span>sex</a>
<a class="sourceLine" id="cb4-15" title="15">nhis_enc<span class="op">$</span>hisp &lt;-<span class="st"> </span>nhis<span class="op">$</span>hisp</a>
<a class="sourceLine" id="cb4-16" title="16">nhis_enc<span class="op">$</span>race &lt;-<span class="st"> </span>nhis<span class="op">$</span>race</a>
<a class="sourceLine" id="cb4-17" title="17">nhis_enc<span class="op">$</span>inv_wt &lt;-<span class="st"> </span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>nhis<span class="op">$</span>svywt)</a></code></pre></div>
<p>The pre-processed NHIS data will be split into three datasets:</p>
<ul>
<li>A training set <code>train</code> for training the initial prediction models (55 % of data)</li>
<li>An auditing set <code>post</code> for post-processing the initial models with MCBoost (20 %)</li>
<li>A test set <code>test</code>for model evaluation (25 %)</li>
</ul>
<p>To increase the difficulty of the prediction task, we sample from the NHIS data such that the prevalence of demographic subgroups in the test data differs from their prevalence in the training and auditing data. This is achieved by employing weighted sampling from NHIS (variable <code>inv_wt</code> from above).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">set.seed</span>(<span class="dv">2953</span>)</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">test &lt;-<span class="st"> </span>nhis_enc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice_sample</span>(<span class="dt">prop =</span> <span class="fl">0.25</span>, <span class="dt">weight_by =</span> inv_wt)</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5">nontest_g &lt;-<span class="st"> </span>nhis_enc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">anti_join</span>(test, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>)</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">train_g &lt;-<span class="st"> </span>nontest_g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice_sample</span>(<span class="dt">prop =</span> <span class="fl">0.75</span>)</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9">post &lt;-<span class="st"> </span>nontest_g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">anti_join</span>(train_g, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>ID, <span class="op">-</span>svywt, <span class="op">-</span>inv_wt, <span class="op">-</span><span class="kw">c</span>(sex<span class="op">:</span>race))</a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">train &lt;-<span class="st"> </span>train_g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>ID, <span class="op">-</span>svywt, <span class="op">-</span>inv_wt, <span class="op">-</span><span class="kw">c</span>(sex<span class="op">:</span>race), <span class="op">-</span><span class="kw">c</span>(sex2<span class="op">:</span>race3))</a></code></pre></div>
<p>As a result, non-hispanic white individuals (<code>hisp2</code>) are overrepresented and hispanic individuals are underrepresented in both the training and auditing set, compared to their prevalence in the test set.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">train_g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(sex2<span class="op">:</span>race3), mean)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co"># hispanic individuals</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(train_g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(hisp2<span class="op">:</span>hisp4), mean))</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">post <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(sex2<span class="op">:</span>race3), mean)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co"># hispanic individuals</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(post <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(hisp2<span class="op">:</span>hisp4), mean))</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(sex2<span class="op">:</span>race3), mean)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co"># hispanic individuals</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(hisp2<span class="op">:</span>hisp4), mean))</a></code></pre></div>
</div>
<div id="scenario-1-improve-subgroup-accuracy" class="section level2">
<h2>Scenario 1: Improve Subgroup Accuracy</h2>
<p>We train an initial model for predicting healthcare coverage with the training set. Here, we use a neural network with one hidden layer, rather naively with little tweaking.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">nnet &lt;-<span class="st"> </span><span class="kw">neuralnet</span>(notcov <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="dt">hidden =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">linear.output =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="dt">err.fct =</span> <span class="st">&#39;ce&#39;</span>,</a>
<a class="sourceLine" id="cb9-5" title="5">  <span class="dt">threshold =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">  <span class="dt">lifesign =</span> <span class="st">&#39;full&#39;</span>,</a>
<a class="sourceLine" id="cb9-7" title="7">  <span class="dt">data =</span> train</a>
<a class="sourceLine" id="cb9-8" title="8">)</a></code></pre></div>
<div id="mcboost-auditing" class="section level3">
<h3>MCBoost Auditing</h3>
<p>We prepare a function that allows us to pass the predictions of the model to MCBoost for post-processing.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">init_nnet =<span class="st"> </span><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw">predict</span>(nnet, data)[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb10-3" title="3">}</a></code></pre></div>
<p>To showcase different use cases of MCBoost, we prepare two post-processing data sets based on the auditing set. The first set includes only the predictor variables that were used by the initial models, whereas the second set will allow post-processing based on our demographic subgroups of interest (sex, hispanic ethnicity, race).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">d1 &lt;-<span class="st"> </span><span class="kw">select</span>(post, <span class="op">-</span><span class="kw">c</span>(notcov, sex2<span class="op">:</span>race3))</a>
<a class="sourceLine" id="cb11-2" title="2">d2 &lt;-<span class="st"> </span><span class="kw">select</span>(post, <span class="op">-</span>notcov)</a>
<a class="sourceLine" id="cb11-3" title="3">l &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">one_hot</span>(post<span class="op">$</span>notcov)</a></code></pre></div>
<p>We initialize two custom auditors for MCBoost: Ridge regression with a small penalty on model complexity, and a <code>SubpopAuditorFitter</code> with a fixed set of subpopulations.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">ridge =<span class="st"> </span>LearnerAuditorFitter<span class="op">$</span><span class="kw">new</span>(<span class="kw">lrn</span>(<span class="st">&quot;regr.glmnet&quot;</span>, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> <span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(post)))</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3">pops =<span class="st"> </span>SubpopAuditorFitter<span class="op">$</span><span class="kw">new</span>(<span class="kw">list</span>(<span class="st">&quot;sex2&quot;</span>, <span class="st">&quot;hisp2&quot;</span>, <span class="st">&quot;hisp3&quot;</span>, <span class="st">&quot;hisp4&quot;</span>, <span class="st">&quot;race2&quot;</span>, <span class="st">&quot;race3&quot;</span>))</a></code></pre></div>
<p>The ridge regression will only be given access to the initial predictor variables when post-processing the neural net predictions with the auditing data. In contrast, we guide the subpop-fitter to audit the initial predictions explicitly on the outlined subpopulations (sex, hispanic ethnicity, race). In summary, we have:</p>
<ul>
<li><code>nnet</code>: Initial neural net</li>
<li><code>nnet_mc_ridge</code>: Neural net, post-processed with ridge regression and the initial set of predictor variables</li>
<li><code>nnet_mc_subpop</code>: Neural net, post-processed with a fixed set of subpopulations</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">nnet_mc_ridge =<span class="st"> </span>MCBoost<span class="op">$</span><span class="kw">new</span>(<span class="dt">init_predictor =</span> init_nnet,</a>
<a class="sourceLine" id="cb13-2" title="2">                            <span class="dt">auditor_fitter =</span> ridge,</a>
<a class="sourceLine" id="cb13-3" title="3">                            <span class="dt">multiplicative =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb13-4" title="4">                            <span class="dt">partition =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb13-5" title="5">                            <span class="dt">max_iter =</span> <span class="dv">15</span>)</a>
<a class="sourceLine" id="cb13-6" title="6">nnet_mc_ridge<span class="op">$</span><span class="kw">multicalibrate</span>(d1, l)</a>
<a class="sourceLine" id="cb13-7" title="7"></a>
<a class="sourceLine" id="cb13-8" title="8">nnet_mc_subpop =<span class="st"> </span>MCBoost<span class="op">$</span><span class="kw">new</span>(<span class="dt">init_predictor =</span> init_nnet,</a>
<a class="sourceLine" id="cb13-9" title="9">                             <span class="dt">auditor_fitter =</span> pops,</a>
<a class="sourceLine" id="cb13-10" title="10">                             <span class="dt">partition =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb13-11" title="11">                             <span class="dt">max_iter =</span> <span class="dv">15</span>)</a>
<a class="sourceLine" id="cb13-12" title="12">nnet_mc_subpop<span class="op">$</span><span class="kw">multicalibrate</span>(d2, l)</a></code></pre></div>
</div>
<div id="model-evaluation" class="section level3">
<h3>Model Evaluation</h3>
<p>Next, we use the initial and post-processed models to predict the outcome in the test data. We compute predicted probabilities and class predictions.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">test<span class="op">$</span>nnet &lt;-<span class="st"> </span><span class="kw">predict</span>(nnet, <span class="dt">newdata =</span> test)[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb14-2" title="2">test<span class="op">$</span>nnet_mc_ridge &lt;-<span class="st"> </span>nnet_mc_ridge<span class="op">$</span><span class="kw">predict_probs</span>(test)</a>
<a class="sourceLine" id="cb14-3" title="3">test<span class="op">$</span>nnet_mc_subpop &lt;-<span class="st"> </span>nnet_mc_subpop<span class="op">$</span><span class="kw">predict_probs</span>(test)</a>
<a class="sourceLine" id="cb14-4" title="4"></a>
<a class="sourceLine" id="cb14-5" title="5">test<span class="op">$</span>c_nnet &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>nnet)</a>
<a class="sourceLine" id="cb14-6" title="6">test<span class="op">$</span>c_nnet_mc_ridge &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>nnet_mc_ridge)</a>
<a class="sourceLine" id="cb14-7" title="7">test<span class="op">$</span>c_nnet_mc_subpop &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>nnet_mc_subpop)</a>
<a class="sourceLine" id="cb14-8" title="8">test<span class="op">$</span>label &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">one_hot</span>(test<span class="op">$</span>notcov)</a></code></pre></div>
<p>Here we compare the overall accuracy of the initial and post-processed models. Overall, we observe little differences in performance.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">mean</span>(test<span class="op">$</span>c_nnet <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">mean</span>(test<span class="op">$</span>c_nnet_mc_ridge <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb15-3" title="3"><span class="kw">mean</span>(test<span class="op">$</span>c_nnet_mc_subpop <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a></code></pre></div>
<p>However, we might be concerned with model performance for smaller subpopulations. In the following, we focus on subgroups defined by 2-way conjunctions of sex, hispanic ethnicity, and race.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(sex, hisp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex_hisp =</span> <span class="kw">cur_group_id</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(sex, race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex_race =</span> <span class="kw">cur_group_id</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="st">  </span><span class="kw">group_by</span>(hisp, race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">hisp_race =</span> <span class="kw">cur_group_id</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb16-9" title="9"></a>
<a class="sourceLine" id="cb16-10" title="10">grouping_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;hisp&quot;</span>, <span class="st">&quot;race&quot;</span>, <span class="st">&quot;sex_hisp&quot;</span>, <span class="st">&quot;sex_race&quot;</span>, <span class="st">&quot;hisp_race&quot;</span>)</a>
<a class="sourceLine" id="cb16-11" title="11"></a>
<a class="sourceLine" id="cb16-12" title="12">eval &lt;-<span class="st"> </span><span class="kw">map</span>(grouping_vars, group_by_at, <span class="dt">.tbl =</span> test) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="st">  </span><span class="kw">map</span>(summarise,</a>
<a class="sourceLine" id="cb16-14" title="14">      <span class="st">&#39;accuracy_nnet&#39;</span> =<span class="st"> </span><span class="kw">mean</span>(c_nnet <span class="op">==</span><span class="st"> </span>label),</a>
<a class="sourceLine" id="cb16-15" title="15">      <span class="st">&#39;accuracy_nnet_mc_ridge&#39;</span> =<span class="st"> </span><span class="kw">mean</span>(c_nnet_mc_ridge <span class="op">==</span><span class="st"> </span>label),</a>
<a class="sourceLine" id="cb16-16" title="16">      <span class="st">&#39;accuracy_nnet_mc_subpop&#39;</span> =<span class="st"> </span><span class="kw">mean</span>(c_nnet_mc_subpop <span class="op">==</span><span class="st"> </span>label),</a>
<a class="sourceLine" id="cb16-17" title="17">      <span class="st">&#39;size&#39;</span> =<span class="st"> </span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="st">  </span><span class="kw">bind_rows</span>()</a></code></pre></div>
<p>We evaluate classification accuracy on these subpopulations, and order the results according to the size of the selected subgroups (<code>size</code>). Subgroup accuracy varies between methods, with MCBoost-Ridge (<code>nnet_mc_ridge</code>) and MCBoost-Subpop (<code>nnet_mc_subpop</code>) stabilizing subgroup performance when compared to the initial model, respectively.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">eval <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(size)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">  </span><span class="kw">select</span>(size, accuracy_nnet<span class="op">:</span>accuracy_nnet_mc_subpop) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  </span><span class="kw">round</span>(., <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  </span><span class="kw">formattable</span>(., <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(eval), <span class="cf">function</span>(row) {</a>
<a class="sourceLine" id="cb17-6" title="6">  <span class="kw">area</span>(row, <span class="dt">col =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">4</span>) <span class="op">~</span><span class="st"> </span><span class="kw">color_tile</span>(<span class="st">&quot;transparent&quot;</span>, <span class="st">&quot;lightgreen&quot;</span>)</a>
<a class="sourceLine" id="cb17-7" title="7">    }))</a></code></pre></div>
</div>
</div>
<div id="scenario-2-improve-subgroup-calibration" class="section level2">
<h2>Scenario 2: Improve Subgroup Calibration</h2>
<p>In this scenario, we use a random forest with the default settings of the ranger package as the initial predictor.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">rf &lt;-<span class="st"> </span><span class="kw">ranger</span>(notcov <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">probability =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div id="mcboost-auditing-1" class="section level3">
<h3>MCBoost Auditing</h3>
<p>We again prepare a function to pass the predictions to MCBoost for post-processing.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">init_rf =<span class="st"> </span><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="kw">predict</span>(rf, data)<span class="op">$</span>prediction[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb19-3" title="3">}</a></code></pre></div>
<p>We use two custom auditors for MCBoost, i.e., ridge and lasso regression with different penalties on model complexity.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">ridge =<span class="st"> </span>LearnerAuditorFitter<span class="op">$</span><span class="kw">new</span>(<span class="kw">lrn</span>(<span class="st">&quot;regr.glmnet&quot;</span>, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> <span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(post)))</a>
<a class="sourceLine" id="cb20-2" title="2"></a>
<a class="sourceLine" id="cb20-3" title="3">lasso =<span class="st"> </span>LearnerAuditorFitter<span class="op">$</span><span class="kw">new</span>(<span class="kw">lrn</span>(<span class="st">&quot;regr.glmnet&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">lambda =</span> <span class="dv">40</span> <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(post)))</a></code></pre></div>
<p>The ridge regression will only be given access to the initial predictor variables when post-processing the random forest predictions. In contrast, we allow the lasso regression to audit the initial predictions both with the initial predictors and the subpopulations (sex, hispanic ethnicity, race). In summary, we have:</p>
<ul>
<li><code>rf</code>: Initial random forest</li>
<li><code>rf_mc_ridge</code>: Random forest, post-processed with ridge regression and the initial set of predictor variables</li>
<li><code>rf_mc_lasso</code>: Random forest, post-processed with lasso regression and the extended set of predictors</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">rf_mc_ridge =<span class="st"> </span>MCBoost<span class="op">$</span><span class="kw">new</span>(<span class="dt">init_predictor =</span> init_rf,</a>
<a class="sourceLine" id="cb21-2" title="2">                          <span class="dt">auditor_fitter =</span> ridge,</a>
<a class="sourceLine" id="cb21-3" title="3">                          <span class="dt">multiplicative =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb21-4" title="4">                          <span class="dt">partition =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb21-5" title="5">                          <span class="dt">max_iter =</span> <span class="dv">15</span>)</a>
<a class="sourceLine" id="cb21-6" title="6">rf_mc_ridge<span class="op">$</span><span class="kw">multicalibrate</span>(d1, l)</a>
<a class="sourceLine" id="cb21-7" title="7"></a>
<a class="sourceLine" id="cb21-8" title="8">rf_mc_lasso =<span class="st"> </span>MCBoost<span class="op">$</span><span class="kw">new</span>(<span class="dt">init_predictor =</span> init_rf,</a>
<a class="sourceLine" id="cb21-9" title="9">                          <span class="dt">auditor_fitter =</span> lasso,</a>
<a class="sourceLine" id="cb21-10" title="10">                          <span class="dt">multiplicative =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb21-11" title="11">                          <span class="dt">partition =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb21-12" title="12">                          <span class="dt">max_iter =</span> <span class="dv">15</span>)</a>
<a class="sourceLine" id="cb21-13" title="13">rf_mc_lasso<span class="op">$</span><span class="kw">multicalibrate</span>(d2, l)</a></code></pre></div>
</div>
<div id="model-evaluation-1" class="section level3">
<h3>Model Evaluation</h3>
<p>We again compute predicted probabilities and class predictions using the initial and post-processed models.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">test<span class="op">$</span>rf &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, test)<span class="op">$</span>prediction[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb22-2" title="2">test<span class="op">$</span>rf_mc_ridge &lt;-<span class="st"> </span>rf_mc_ridge<span class="op">$</span><span class="kw">predict_probs</span>(test)</a>
<a class="sourceLine" id="cb22-3" title="3">test<span class="op">$</span>rf_mc_lasso &lt;-<span class="st"> </span>rf_mc_lasso<span class="op">$</span><span class="kw">predict_probs</span>(test)</a>
<a class="sourceLine" id="cb22-4" title="4"></a>
<a class="sourceLine" id="cb22-5" title="5">test<span class="op">$</span>c_rf &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>rf)</a>
<a class="sourceLine" id="cb22-6" title="6">test<span class="op">$</span>c_rf_mc_ridge &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>rf_mc_ridge)</a>
<a class="sourceLine" id="cb22-7" title="7">test<span class="op">$</span>c_rf_mc_lasso &lt;-<span class="st"> </span><span class="kw">round</span>(test<span class="op">$</span>rf_mc_lasso)</a></code></pre></div>
<p>Here we compare the overall accuracy of the initial and post-processed models. As before, we observe small differences in overall performance.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">mean</span>(test<span class="op">$</span>c_rf <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">mean</span>(test<span class="op">$</span>c_rf_mc_ridge <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">mean</span>(test<span class="op">$</span>c_rf_mc_lasso <span class="op">==</span><span class="st"> </span>test<span class="op">$</span>label)</a></code></pre></div>
<p>However, we might be concerned with calibration in subpopulations. In the following we focus on subgroups defined by 2-way conjunctions of sex, hispanic ethnicity, and race.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">eval &lt;-<span class="st"> </span><span class="kw">map</span>(grouping_vars, group_by_at, <span class="dt">.tbl =</span> test) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="st">  </span><span class="kw">map</span>(summarise,</a>
<a class="sourceLine" id="cb24-3" title="3">      <span class="st">&#39;bias_rf&#39;</span> =<span class="st"> </span><span class="kw">abs</span>(<span class="kw">mean</span>(rf) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(label))<span class="op">*</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb24-4" title="4">      <span class="st">&#39;bias_rf_mc_ridge&#39;</span> =<span class="st"> </span><span class="kw">abs</span>(<span class="kw">mean</span>(rf_mc_ridge) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(label))<span class="op">*</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb24-5" title="5">      <span class="st">&#39;bias_rf_mc_lasso&#39;</span> =<span class="st"> </span><span class="kw">abs</span>(<span class="kw">mean</span>(rf_mc_lasso) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(label))<span class="op">*</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb24-6" title="6">      <span class="st">&#39;size&#39;</span> =<span class="st"> </span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="st">  </span><span class="kw">bind_rows</span>()</a></code></pre></div>
<p>This evaluation focuses on the difference between the average predicted risk of healthcare non-coverage and the observed proportion of non-coverage in the test data for subgroups. Considering the MCBoost-Ridge (<code>rf_mc_ridge</code>) and MCBoost-Lasso (<code>rf_mc_lasso</code>) results, post-processing with MCBoost reduces bias for many subpopulations.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">eval <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(size)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="st">  </span><span class="kw">select</span>(size, bias_rf<span class="op">:</span>bias_rf_mc_lasso) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="st">  </span><span class="kw">round</span>(., <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="st">  </span><span class="kw">formattable</span>(., <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(eval), <span class="cf">function</span>(row) {</a>
<a class="sourceLine" id="cb25-6" title="6">  <span class="kw">area</span>(row, <span class="dt">col =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">4</span>) <span class="op">~</span><span class="st"> </span><span class="kw">color_tile</span>(<span class="st">&quot;lightgreen&quot;</span>, <span class="st">&quot;transparent&quot;</span>)</a>
<a class="sourceLine" id="cb25-7" title="7">    }))</a></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
